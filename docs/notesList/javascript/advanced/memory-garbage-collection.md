# 内存管理与垃圾回收

> JavaScript 是使用垃圾回收的编程语言，开发者不需要操心内存分配和回收

## 内存管理

### 栈内存

- 原始值（String、Number、Boolean、null、undefined、Symbol），大小固定

### 堆内存

- 引用值
- 闭包中的变量

### 内存泄漏

- 全局变量
- 定时器（setInterval）
- 闭包



## 垃圾回收

#### 内存生命周期

1. 内存分配
2. 使用内存
3. 释放内存
   - JavaScript通过 <mark>自动内存管理</mark> 实现内存分配和闲置资源回收

### 回收策略

基本思路是，确定哪个变量不会再使用，然后释放它占用的内存。

这个过程是周期性的，即垃圾回收程序每隔一定时间(或者说在代码执 行过程中某个预定的收集时间)就会自动运行。

#### 特殊

- 全局变量
  - 全局上下文在应用程序退出前才会被销毁，比如关闭网页或退出浏览器；在这之前，上下文的变量对象中的变量，即全局变量，不会被当成垃圾回收
- 闭包中的变量
  - 闭包中的变量并不保存中栈内存中，而是保存在堆内存中

### 标记策略

1. `引用计数` (reference counting)
   - 垃圾回收程序下次运行的时候就会释放引用数为 0 的值的内存
   - 不能解决循环引用的问题（objectA 和 objectB 通过各自的属性相互引用），可能导致内存泄漏
2. `标记清理` (mark-and-sweep)
   - 最常用的垃圾回收策略，先给当前不使用的值加上标记，再回来回收它们的内存
   - 垃圾回收程序会在运行的时候，给存储在内存中的所有变量都加上标记，从根部出发将能触及到的对象的标记清除（将所有在上下文中的变量，以及被在上下文中的变量引用的变量的标记去掉），销毁那些带标记的值（因为任何在上下文中的变量都访问不到它们了），并回收它们所占用的内存空间。

### 性能

1. 对浏览器而言，调度垃圾回收程序方面的问题会导致性能下降

2. 对开发者而言，理论上如果能够合理使用分配的内存，同时避免多余的垃圾回收，那就可以保住因释放内存而损失的性能

   - 赋值 `null`，解除对象的引用。
     - 为促进内存回收，全局对象、全局对象的属性和循环引用都应该在不需要时解除引用

   - 静态分配（内存）策略



## TODO

[为什么闭包不会被垃圾回收清除 · Issue #3 · raxxarr/note · GitHub](https://github.com/raxxarr/note/issues/3)

[「前端进阶」JS中的内存管理](https://juejin.cn/post/6844903869525262349)

 [js的垃圾回收机制](https://juejin.cn/post/6854573211716321287#heading-3)